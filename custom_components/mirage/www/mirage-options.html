<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mirage UI Options</title>
</head>
<body>
    <script type="module">
        class HaConfigPanelMirage extends HTMLElement {
            constructor() {
                super();
                this._hass = null;
                this._configEntryId = null;
                this._rootElement = null;
                this._reactRoot = null;
                this._stylesApplied = false;
            }

            set hass(hass) {
                this._hass = hass;
                this._render();
            }
            
            set configEntryId(id) {
                this._configEntryId = id;
            }

            connectedCallback() {
                if (!this._rootElement) {
                    this.attachShadow({ mode: 'open' });
                    this._rootElement = document.createElement('div');
                    this._rootElement.style.height = '100%';
                    this.shadowRoot.appendChild(this._rootElement);
                }
            }

            async _render() {
                if (!this._hass || !this.configEntryId || !this._rootElement) {
                    return;
                }
                
                if (!this._reactRoot) {
                    // Import React and ReactDOM dynamically
                    const React = await import('react');
                    const ReactDOM = await import('react-dom/client');
                    this._reactRoot = ReactDOM.createRoot(this._rootElement);
                }
                
                if (!this._stylesApplied) {
                    const styleTag = document.createElement('style');
                    styleTag.textContent = `
                        :host {
                            display: block;
                            height: 100%;
                            background-color: transparent;
                        }
                        .upload-btn {
                            background-color: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            color: #e5e7eb;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 14px;
                            transition: background-color 0.2s;
                        }
                        .upload-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
                        .clear-btn {
                            background-color: rgba(239, 68, 68, 0.1);
                            border: 1px solid rgba(239, 68, 68, 0.2);
                            color: #fca5a5;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 14px;
                            transition: background-color 0.2s;
                        }
                        .clear-btn:hover { background-color: rgba(239, 68, 68, 0.2); }
                    `;
                    this.shadowRoot.appendChild(styleTag);
                    this._stylesApplied = true;
                }

                // Import the rest of the app and render it
                const { default: App, SettingsProvider, SettingsPanel, HAConnection } = await (async () => {
                    const [
                        appModule,
                        settingsProviderModule, 
                        settingsPanelModule, 
                        haConnectionModule
                    ] = await Promise.all([
                        import('/mirage_static/App.tsx'),
                        import('/mirage_static/components/SettingsProvider.tsx'),
                        import('/mirage_static/components/SettingsPanel.tsx'),
                        import('/mirage_static/ha-connection.ts')
                    ]);
                    return { 
                        default: appModule.default,
                        SettingsProvider: settingsProviderModule.SettingsProvider,
                        SettingsPanel: settingsPanelModule.SettingsPanel,
                        HAConnection: haConnectionModule.HAConnection,
                    };
                })();

                const haConnection = new HAConnection(this._hass, this.configEntryId);
                const React = await import('react');

                const SettingsWrapper = () => {
                    return React.createElement(
                        SettingsProvider,
                        { haConnection: haConnection },
                        React.createElement(SettingsPanel, {
                            isOpen: true,
                            onClose: () => {},
                            isHaIntegration: true
                        })
                    );
                };
                
                this._reactRoot.render(React.createElement(React.StrictMode, {}, React.createElement(SettingsWrapper)));
            }
        }
        customElements.define('ha-config-panel-mirage', HaConfigPanelMirage);
    </script>
</body>
</html>
